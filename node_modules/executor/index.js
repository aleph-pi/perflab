#!/usr/bin/env node

'use strict';

var spawn = require('child_process').spawn;

function run(cmd, args, opts) {
	var stdout = '', stderr = '';
	var child = spawn(cmd, args, opts);
	child.stdout.on('data', (data) => stdout += data);
	child.stderr.on('data', (data) => stderr += data);
	console.log(cmd + ' ' + args.join(' '));
	return new Promise((resolve, reject) => {
		child.on('exit', (status) => {
			if (status) {
				reject({stdout, stderr, status});
			} else {
				resolve({stdout, stderr});
			}
		});
	});
}

function runWatch(cmd, args, opts, match)
{
	console.log(cmd + ' ' + args.join(' '));
	return new Promise((resolve, reject) => {
		var matched = false;
		var stdout = '', stderr = '';
		var child = spawn(cmd, args, opts);
		child.stdout.on('data', (data) => stdout += data);
		child.stderr.on('data', (data) => {
			stderr += data;
			if (!matched && stderr.match(match)) {
				matched = true;
				resolve({stdout, stderr});
			}
		});
		child.on('exit', (status) => {
			if (matched) {
				// do nothing
			} else {
				reject({stdout, stderr, status});
			}
		});
	});
}

module.exports = { run, runWatch };
